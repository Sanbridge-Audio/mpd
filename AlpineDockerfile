#Start dockerfile by creating all the dependencies needed.
FROM alpine AS depend 
LABEL maintainer="Matt Dickinson <matt@sanbridge.org>" 

#Set the working directory of the dockerfile at this stage.
ENV HOME /root
#Installation of MPD
RUN apk update && apk add mpd

#Changing stage for the dockerfile to the configuration of MPD.
FROM alpine AS config 

#Set the s6 overlay version. Makes running mpd much easier. 
ARG S6_VERSION=2.2.0.3

COPY --from=mpdbuild /usr/local/bin/mpc /usr/local/bin
COPY --from=mpdbuild /usr/local/bin/mpd /usr/local/bin


#Download the most recent s6 overlay.
ADD https://github.com/just-containers/s6-overlay/releases/download/v2.2.0.3/s6-overlay-amd64.tar.gz /tmp
RUN tar xzf /tmp/s6-overlay-amd64.tar.gz -C /

#Make needed directories. Should match the config file.
RUN  mkdir -p /var/lib/mpd/music \
	&& mkdir -p ~/.mpd/playlists \
	&& mkdir -p ~/.config/mpd \
	&& chmod a+w ~/.mpd/playlists

#Create music, playlist, tmp (for sending audio to snapcast) and config folder.
VOLUME /var/lib/mpd/music /.mpd/playlists /tmp #/.config/mpd 

#Creating databases.
RUN touch /.mpd/mpd.log \
	&& touch /.mpd/sticker.sql \
	&& touch /.mpd/pid \
	&& touch /.mpd/mpdstate \
	&& touch /.mpd/tag_cache

#Add permissions to created databases
RUN chmod 777 /.mpd/mpd.log \
	&& chmod 777 /.mpd/sticker.sql \
	&& chown 777 /.mpd/pid \
	&& chmod 777 /.mpd/mpdstate \
	&& chmod 777 /.mpd/tag_cache

#Copy preset configuration file into image from folder. 
COPY mpd.conf /usr/local/etc

#Add permissions so that the configuration file will actually work
RUN chmod 777 /usr/local/etc/mpd.conf

#Copy a services file that will allow MPD to find the mpd.conf file. 
COPY mpd.service /usr/local/lib/systemd/system 

#Copy stations playlist into mpd playlists folder that was created earlier.
COPY Stations.m3u /.mpd/playlists 

FROM config as mpd
ENV TZ="America/New_York"
#Consistent command across multiple types of mpd dockerfiles.
CMD ["mpd", "--stdout", "--no-daemon"]

ENTRYPOINT ["/init"]

#Exposing the port so that the container will send out it's information across the network. 
EXPOSE 6600


